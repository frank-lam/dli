# 使用示例<a name="dli_01_0314"></a>

通过批处理方式支持提交用户程序到spark集群中运行。假设用户程序包为“spark-examples\_2.11-2.1.0.jar“。

1.  上传批处理程序文件到集群。调用上传jar包接口（URI格式为：POST /v2.0/\{project\_id\}/resources/jars），上传用户OBS上的“spark-examples\_2.11-2.1.0.jar“到DLI服务。上传成功后将返回已上传的资源包名，供创建批处理时使用。
    -   请求参数说明

        **表 1**  请求参数说明

        <a name="table12844221443"></a>
        <table><thead align="left"><tr id="row02887226411"><th class="cellrowborder" valign="top" width="25%" id="mcps1.2.5.1.1"><p id="p18288192211415"><a name="p18288192211415"></a><a name="p18288192211415"></a>名称</p>
        </th>
        <th class="cellrowborder" valign="top" width="15%" id="mcps1.2.5.1.2"><p id="p172889221743"><a name="p172889221743"></a><a name="p172889221743"></a>是否必选</p>
        </th>
        <th class="cellrowborder" valign="top" width="15%" id="mcps1.2.5.1.3"><p id="p142894227417"><a name="p142894227417"></a><a name="p142894227417"></a>参数类型</p>
        </th>
        <th class="cellrowborder" valign="top" width="45%" id="mcps1.2.5.1.4"><p id="p182909224416"><a name="p182909224416"></a><a name="p182909224416"></a>说明</p>
        </th>
        </tr>
        </thead>
        <tbody><tr id="row72904222047"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.5.1.1 "><p id="p1929117221249"><a name="p1929117221249"></a><a name="p1929117221249"></a>paths</p>
        </td>
        <td class="cellrowborder" valign="top" width="15%" headers="mcps1.2.5.1.2 "><p id="p12919227412"><a name="p12919227412"></a><a name="p12919227412"></a>是</p>
        </td>
        <td class="cellrowborder" valign="top" width="15%" headers="mcps1.2.5.1.3 "><p id="p529212221146"><a name="p529212221146"></a><a name="p529212221146"></a>List of String</p>
        </td>
        <td class="cellrowborder" valign="top" width="45%" headers="mcps1.2.5.1.4 "><p id="p429218221345"><a name="p429218221345"></a><a name="p429218221345"></a>用户OBS对象的URL，可以通过OBS页面获取，格式形如：</p>
        <p id="p15952254358"><a name="p15952254358"></a><a name="p15952254358"></a>https://&lt;桶名&gt;.&lt;OBS域名&gt;/&lt;OBS对象键&gt;</p>
        </td>
        </tr>
        </tbody>
        </table>

        >![](public_sys-resources/icon-note.gif) **说明：**   
        >用户批处理程序文件需先上传到用户自己的OBS上，之后在paths字段里填入已上传的OBS对象URL。  

    -   请求样例：

        ```
        {
            "paths": [
                "https://resource.obs.cn-east-2.myhwclouds.com/xxx/spark-examples_2.11-2.1.0.jar"
            ]
        }
        ```

    -   响应样例：

        ```
        {
            "resource_names": [
                "spark-examples_2.11-2.1.0.jar"
            ]
        }
        ```


2.  查看资源包是否上传成功。调用查看资源包接口（URI格式为：GET /v2.0/\{project\_id\}/resources/\{resource\_name\}）。resource\_name设置为spark-examples\_2.11-2.1.0.jar，以查看该资源包状态。当返回结果中status字段为READY，表示资源包上传成功。

    成功响应样例

    ```
    {
        "create_time": 1527147104026,
        "update_time": 1527147114240,
        "resource_type": "jar",
        "resource_name": "spark-examples_2.11-2.1.0.jar",
        "status": "READY",
        "underlying_name": "9b812abc-7166-4b54-975d-0ca69736bc93_spark-examples_2.11-2.1.0.jar"
    }
    ```

3.  创建批处理作业。确认资源包准备就绪后，调用创建批处理接口（URI格式为：POST /v2.0/\{project\_id\}/batches），在file字段中填入需要运行的批处理作业资源名spark-examples\_2.11-2.1.0.jar，在className字段中填写jar包里的主类，在cluster\_name字段中填入在[创建Spark集群](创建Spark集群.md)步骤中创建的集群名，sc\_type选择A类型\(资源类型说明请参考[表2](#zh-cn_topic_0103343292_zh-cn_topic_0102902454_table1656812183429)\)。

    **表 2**  资源类型表

    <a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_table1656812183429"></a>
    <table><thead align="left"><tr id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_row1656811816422"><th class="cellrowborder" valign="top" width="10.1010101010101%" id="mcps1.2.8.1.1"><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p4558132410427"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p4558132410427"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p4558132410427"></a>资源类型</p>
    </th>
    <th class="cellrowborder" valign="top" width="16.16161616161616%" id="mcps1.2.8.1.2"><p id="zh-cn_topic_0103343292_p6651820612"><a name="zh-cn_topic_0103343292_p6651820612"></a><a name="zh-cn_topic_0103343292_p6651820612"></a>物理资源</p>
    </th>
    <th class="cellrowborder" valign="top" width="13.13131313131313%" id="mcps1.2.8.1.3"><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1656242494217"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1656242494217"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1656242494217"></a>driverCores</p>
    </th>
    <th class="cellrowborder" valign="top" width="15.151515151515149%" id="mcps1.2.8.1.4"><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p9564192494215"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p9564192494215"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p9564192494215"></a>executorCores</p>
    </th>
    <th class="cellrowborder" valign="top" width="14.14141414141414%" id="mcps1.2.8.1.5"><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p155668246423"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p155668246423"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p155668246423"></a>driverMemory</p>
    </th>
    <th class="cellrowborder" valign="top" width="16.16161616161616%" id="mcps1.2.8.1.6"><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p5570124184218"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p5570124184218"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p5570124184218"></a>executorMemory</p>
    </th>
    <th class="cellrowborder" valign="top" width="15.151515151515149%" id="mcps1.2.8.1.7"><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1357210241429"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1357210241429"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1357210241429"></a>numExecutor</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_row2056814184423"><td class="cellrowborder" valign="top" width="10.1010101010101%" headers="mcps1.2.8.1.1 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p35751124204210"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p35751124204210"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p35751124204210"></a>A</p>
    </td>
    <td class="cellrowborder" valign="top" width="16.16161616161616%" headers="mcps1.2.8.1.2 "><p id="zh-cn_topic_0103343292_p106613203119"><a name="zh-cn_topic_0103343292_p106613203119"></a><a name="zh-cn_topic_0103343292_p106613203119"></a>8核32G内存</p>
    </td>
    <td class="cellrowborder" valign="top" width="13.13131313131313%" headers="mcps1.2.8.1.3 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1857717243428"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1857717243428"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1857717243428"></a>2</p>
    </td>
    <td class="cellrowborder" valign="top" width="15.151515151515149%" headers="mcps1.2.8.1.4 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p105791243427"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p105791243427"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p105791243427"></a>1</p>
    </td>
    <td class="cellrowborder" valign="top" width="14.14141414141414%" headers="mcps1.2.8.1.5 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1458242412426"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1458242412426"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1458242412426"></a>7G</p>
    </td>
    <td class="cellrowborder" valign="top" width="16.16161616161616%" headers="mcps1.2.8.1.6 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p658562484219"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p658562484219"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p658562484219"></a>4G</p>
    </td>
    <td class="cellrowborder" valign="top" width="15.151515151515149%" headers="mcps1.2.8.1.7 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p65871024164212"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p65871024164212"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p65871024164212"></a>6</p>
    </td>
    </tr>
    <tr id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_row11568718144211"><td class="cellrowborder" valign="top" width="10.1010101010101%" headers="mcps1.2.8.1.1 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p65911024114213"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p65911024114213"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p65911024114213"></a>B</p>
    </td>
    <td class="cellrowborder" valign="top" width="16.16161616161616%" headers="mcps1.2.8.1.2 "><p id="zh-cn_topic_0103343292_p633880217"><a name="zh-cn_topic_0103343292_p633880217"></a><a name="zh-cn_topic_0103343292_p633880217"></a>16核64G内存</p>
    </td>
    <td class="cellrowborder" valign="top" width="13.13131313131313%" headers="mcps1.2.8.1.3 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p20592624134213"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p20592624134213"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p20592624134213"></a>2</p>
    </td>
    <td class="cellrowborder" valign="top" width="15.151515151515149%" headers="mcps1.2.8.1.4 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p13594202411428"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p13594202411428"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p13594202411428"></a>2</p>
    </td>
    <td class="cellrowborder" valign="top" width="14.14141414141414%" headers="mcps1.2.8.1.5 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1859632413429"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1859632413429"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1859632413429"></a>7G</p>
    </td>
    <td class="cellrowborder" valign="top" width="16.16161616161616%" headers="mcps1.2.8.1.6 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p19599324114218"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p19599324114218"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p19599324114218"></a>8G</p>
    </td>
    <td class="cellrowborder" valign="top" width="15.151515151515149%" headers="mcps1.2.8.1.7 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p2602124164215"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p2602124164215"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p2602124164215"></a>7</p>
    </td>
    </tr>
    <tr id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_row45681518114212"><td class="cellrowborder" valign="top" width="10.1010101010101%" headers="mcps1.2.8.1.1 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1760622434216"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1760622434216"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p1760622434216"></a>C</p>
    </td>
    <td class="cellrowborder" valign="top" width="16.16161616161616%" headers="mcps1.2.8.1.2 "><p id="zh-cn_topic_0103343292_p19794198826"><a name="zh-cn_topic_0103343292_p19794198826"></a><a name="zh-cn_topic_0103343292_p19794198826"></a>32核128G内存</p>
    </td>
    <td class="cellrowborder" valign="top" width="13.13131313131313%" headers="mcps1.2.8.1.3 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p18608524104211"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p18608524104211"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p18608524104211"></a>4</p>
    </td>
    <td class="cellrowborder" valign="top" width="15.151515151515149%" headers="mcps1.2.8.1.4 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p6609152415425"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p6609152415425"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p6609152415425"></a>2</p>
    </td>
    <td class="cellrowborder" valign="top" width="14.14141414141414%" headers="mcps1.2.8.1.5 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p8611224204210"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p8611224204210"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p8611224204210"></a>15G</p>
    </td>
    <td class="cellrowborder" valign="top" width="16.16161616161616%" headers="mcps1.2.8.1.6 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p10614124134214"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p10614124134214"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p10614124134214"></a>8G</p>
    </td>
    <td class="cellrowborder" valign="top" width="15.151515151515149%" headers="mcps1.2.8.1.7 "><p id="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p161532410428"><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p161532410428"></a><a name="zh-cn_topic_0103343292_zh-cn_topic_0102902454_p161532410428"></a>14</p>
    </td>
    </tr>
    </tbody>
    </table>

    -   请求样例：

        ```
        {
            "file": "spark-examples_2.11-2.1.0.jar",
            "className": "org.apache.spark.examples.SparkPi",
            "sc_type": "A",
            "cluster_name": "cluster1"
        }
        ```

    -   响应样例

        ```
        {
            "id": "98dfb342-d848-44a1-bfb5-78101fef89ae",
            "state": "starting",
            "appId": null,
            "appInfo": {
                "driverLogUrl": null,
                "sparkUiUrl": null
            },
            "log": [
                "stdout: ",
                "\nstderr: ",
                "\nYARN Diagnostics: "
            ]
        }
        ```


4.  查看批处理作业详情。在提交作业之后，调用获取批处理作业详情接口（URI格式为：GET /v2.0/\{project\_id\}/batches/\{batch\_id\}），当返回体state字段为success时，表示批处理作业运行成功。

    成功响应样例

    ```
    {
        "id": "77f708f6-c140-48ab-b9bd-577826a9eb0d",
        "state": "success",
        "appId": "application_1527142513886_0006",
        "appInfo": {
            "driverLogUrl": null,
            "sparkUiUrl": "https://UQuery-cluster-5-0004:26001/proxy/application_1527142513886_0006/"
        },
        "log": [
            "\t queue: default",
            "\t queue user: mls",
            "\t start time: 1527153866040",
            "\t final status: UNDEFINED",
            "\t tracking URL: https://UQuery-cluster-5-0004:26001/proxy/application_1527142513886_0006/",
            "\t user: mls | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "2018-05-24 17:24:36,330 | INFO  | pool-1-thread-1 | Shutdown hook called | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "2018-05-24 17:24:36,331 | INFO  | pool-1-thread-1 | Deleting directory /tmp/spark-dfa43202-1e27-4244-b346-802c790ea3bd | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "\nstderr: ",
            "\nYARN Diagnostics: "
        ]
    }
    ```

5.  查看日志。调用获取批处理作业日志接口（URI格式为：GET /v2.0/\{project\_id\}/batches/\{batch\_id\}/log），可以获取作业提交日志。

    作业提交日志：

    ```
    {
        "id": "77f708f6-c140-48ab-b9bd-577826a9eb0d",
        "from": 59,
        "total": 79,
        "log": [
            "2018-05-24 17:24:32,310 | INFO  | main | Application report for application_1527142513886_0006 (state: ACCEPTED) | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "2018-05-24 17:24:33,315 | INFO  | main | Application report for application_1527142513886_0006 (state: ACCEPTED) | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "2018-05-24 17:24:34,318 | INFO  | main | Application report for application_1527142513886_0006 (state: ACCEPTED) | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "2018-05-24 17:24:35,322 | INFO  | main | Application report for application_1527142513886_0006 (state: ACCEPTED) | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "2018-05-24 17:24:36,325 | INFO  | main | Application report for application_1527142513886_0006 (state: RUNNING) | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "2018-05-24 17:24:36,325 | INFO  | main | ",
            "\t client token: Token { kind: YARN_CLIENT_TOKEN, service:  }",
            "\t diagnostics: N/A",
            "\t ApplicationMaster host: 192.168.0.195",
            "\t ApplicationMaster RPC port: 0",
            "\t queue: default",
            "\t queue user: mls",
            "\t start time: 1527153866040",
            "\t final status: UNDEFINED",
            "\t tracking URL: https://UQuery-cluster-5-0004:26001/proxy/application_1527142513886_0006/",
            "\t user: mls | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "2018-05-24 17:24:36,330 | INFO  | pool-1-thread-1 | Shutdown hook called | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "2018-05-24 17:24:36,331 | INFO  | pool-1-thread-1 | Deleting directory /tmp/spark-dfa43202-1e27-4244-b346-802c790ea3bd | org.apache.spark.internal.Logging$class.logInfo(Logging.scala:54)",
            "\nstderr: ",
            "\nYARN Diagnostics: "
        ]
    }
    ```


